"""
Notificator handlers unit tests
"""

import asyncio

from notificator.notificator import NOTIFICATOR_PERIOD
from notificator.notificator import NotificationType
from notificator.notificator import NotificatorConditions
from notificator.notificator_queue import NotificatorQueue


class TestNotificatorHandlers:
    """
    Notificator handlers tests suite
    """

    async def _init_notificator(self, pool):
        loop = asyncio.get_event_loop()
        conditions = NotificatorConditions(pool)
        await conditions.init()
        queue = NotificatorQueue(NOTIFICATOR_PERIOD, pool, conditions, loop)
        await queue.init()
        return conditions, queue

    async def test_cache_handler(self, asyncpg_pool, http_client):
        """Test cache refresh handler"""
        _, queue = await self._init_notificator(asyncpg_pool)

        # these notified accounts are not in db
        queue.notified_accounts[(1337, 1)] = (NotificationType.CVSS_NOTIFICATION, NotificationType.EXPLOITS_NOTIFICATION)
        queue.notified_accounts[(333, 1)] = NotificationType.CVSS_NOTIFICATION

        resp = await http_client.put("/api/v1/cache", data="")
        assert resp.status == 200

        assert (1337, 1) not in queue.notified_accounts
        assert (333, 1) not in queue.notified_accounts
        NotificatorQueue.delete()
